(function(){function a(){}function b(){function c(){var b=a,c=-1,d=b.length,e;while(++c<d)(e=b[c].on)&&e.apply(this,arguments)}var a=[],b={};return c.on=function(d,e){var f,g;if(arguments.length<2)return(f=b[d])&&f.on;if(f=b[d])f.on=null,a=a.slice(0,g=a.indexOf(f)).concat(a.slice(g+1)),delete b[d];return e&&a.push(b[d]={on:e}),c},c}function g(a,b){function i(){var b=new Image;b.onload=j,b.onerror=k,b.src=a}function j(){g.active--,b(this),h(g)}function k(a){g.active--,++i.attempt<f?g.queued.push(i):b(null),h(g)}var e=(d.lastIndex=0,d).exec(a)[2]||"",g=c[e]||(c[e]={active:0,queued:[]});i.attempt=0,g.queued.push(i),h(g)}function h(a){if(a.active>=e||!a.queued.length)return;a.active++,a.queued.pop()()}function n(a,b){var c=i[a];if(c)return c.previous&&(c.previous.next=c.next,c.next?c.next.previous=c.previous:k=c.previous,c.previous=null,c.next=j,j.previous=c,j=c),c.callbacks?c.callbacks.push(b):b(c.value);c=i[a]={key:a,next:j,previous:null,callbacks:[b]},j?j.previous=c:k=c,j=c,l++,o(),g(a,function(a){var b=c.callbacks;delete c.callbacks,c.value=a,b.forEach(function(b){b(a)})})}function o(){for(var a=k;l>m&&a;a=a.previous){l--,delete i[a.key];if(a.next)a.next.previous=a.previous;else if(k=a.previous)k.next=null;if(a.previous)a.previous.next=a.next;else if(j=a.next)j.previous=null}}function q(){}function s(a,b){if(a[1]>b[1]){var c=a;a=b,b=c}return{x0:a[0],y0:a[1],x1:b[0],y1:b[1],dx:b[0]-a[0],dy:b[1]-a[1]}}function t(a,b,c){var d=Math.floor(b.y0),e=Math.ceil(b.y1);if(a.x0==b.x0&&a.y0==b.y0?a.x0+b.dy/a.dy*a.dx<b.x1:a.x1-b.dy/a.dy*a.dx<b.x0){var f=a;a=b,b=f}var g=a.dx/a.dy,h=b.dx/b.dy,i=a.dx>0,j=b.dx<0;for(var k=d;k<e;k++){var l=Math.ceil(g*Math.max(0,Math.min(a.dy,k+i-a.y0))+a.x0),m=Math.floor(h*Math.max(0,Math.min(b.dy,k+j-b.y0))+b.x0);for(var n=m;n<l;n++)c(n,k)}}function u(a,b,c,d){var e=s(a,b),f=s(b,c),g=s(c,a);if(e.dy>f.dy){var h=e;e=f,f=h}if(e.dy>g.dy){var h=e;e=g,g=h}if(f.dy>g.dy){var h=f;f=g,g=h}e.dy&&t(g,e,d),f.dy&&t(g,f,d)}pixymaps={version:"0.0.2"},pixymaps.dispatch=function(){var c=new a,d=-1,e=arguments.length;while(++d<e)c[arguments[d]]=b();return c},a.prototype.on=function(a,b){var c=a.indexOf("."),d="";return c>0&&(d=a.substring(c+1),a=a.substring(0,c)),arguments.length<2?this[a].on(d):(this[a].on(d,b),this)};var c={},d=/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/,e=4,f=4,i={},j=null,k=null,l=0,m=512;pixymaps.url=function(a){function d(d){var e=d[0],f=d[1],g=d[2],h=1<<g;return/^repeat(-x)?$/.test(c)&&(e%=h)<0&&(e+=h),/^repeat(-y)?$/.test(c)&&(f%=h)<0&&(f+=h),g<0||e<0||e>=h||f<0||f>=h?null:a.replace(/{(.)}/g,function(a,c){switch(c){case"X":return e;case"Y":return f;case"Z":return g;case"S":return b[Math.abs(e+f+g)%b.length]}return c})}var b=[],c="repeat-x";return d.template=function(b){return arguments.length?(a=b,d):a},d.hosts=function(a){return arguments.length?(b=a,d):b},d.repeat=function(a){return arguments.length?(c=a,d):c},d};var p=q.prototype;pixymaps.view=function(){function k(b){var c=Math.pow(2,b);return a.center([d[0]*c,d[1]*c,d[2]+b])}var a=new q,b=[0,0],c=[256,256],d=[.5,.5,0],e=0,f=1,g=0,h=1,i=0,j=pixymaps.dispatch("move");return a.point=function(a){var e=Math.pow(2,d[2]-(a.length<3?0:a[2])),h=(a[0]*e-d[0])*c[0],i=(a[1]*e-d[1])*c[1];return[b[0]/2+f*h-g*i,b[1]/2+g*h+f*i]},a.coordinate=function(a){var e=a[0]-b[0]/2;return dy=a[1]-b[1]/2,[d[0]+(h*e-i*dy)/c[0],d[1]+(i*e+h*dy)/c[1],d[2]]},a.coordinateSize=function(b){return arguments.length?(c=b,j.move.call(a),a):c},a.size=function(c){return arguments.length?(b=c,j.move.call(a),a):b},a.center=function(b){return arguments.length?(d=b,d.length<3&&(d[2]=0),j.move.call(a),a):d},a.zoom=function(a){return arguments.length?k(a-d[2]):d[2]},a.angle=function(b){return arguments.length?(e=b,f=Math.cos(e),g=Math.sin(e),h=Math.cos(-e),i=Math.sin(-e),j.move.call(a),a):e},a.panBy=function(b){return a.center([d[0]-(i*b[1]+h*b[0])/c[0],d[1]-(h*b[1]-i*b[0])/c[1],d[2]])},a.zoomBy=function(b,c,d){if(arguments.length<2)return k(b);arguments.length<3&&(d=a.coordinate(c));var e=k(b).point(d);return a.panBy([c[0]-e[0],c[1]-e[1]])},a.rotateBy=function(b){return a.angle(e+b)},a.on=function(b,c){return arguments.length<1?j.on(b):(j.on(b,c),a)},a};var r=0;p.image=function(){function k(){function C(a,b){B=z.push([a,b,A])}var a=c.size(),b=c.angle(),f=c.center(),g=f[2],k=c.coordinateSize(),l=g-(g=e(g)),m=Math.pow(2,-l),o=c.coordinate([0,0]),p=c.coordinate([a[0],0]),q=c.coordinate(a),r=c.coordinate([0,a[1]]);o[0]*=m,p[0]*=m,q[0]*=m,r[0]*=m,o[1]*=m,p[1]*=m,q[1]*=m,r[1]*=m,o[2]=p[2]=q[2]=r[2]-=l;var s=Math.floor(Math.min(o[0],p[0],q[0],r[0])),t=Math.ceil(Math.max(o[0],p[0],q[0],r[0])),v=Math.floor(Math.min(o[1],p[1],q[1],r[1])),w=Math.ceil(Math.max(o[1],p[1],q[1],r[1])),x=k[0],y=k[1],z=[],A=o[2],B=0;u(o,p,q,C),u(q,r,o,C);var D=a[0]/2+x*(s-f[0]*m)|0,E=a[1]/2+y*(v-f[1]*m)|0;i.style.webkitTransform="matrix3d("+1/m+",0,0,0,0,"+1/m+",0,0,0,0,1,0,"+D+","+E+",0,1)",i.width=(t-s)*x,i.height=(w-v)*y,h.style.width=a[0]+"px",h.style.height=a[1]+"px",z.forEach(function(a){var b=d(a);b!=null&&n(b,function(b){j.drawImage(b,x*(a[0]-s),y*(a[1]-v))})})}var a={},b="image"+ ++r,c=this,d,e=Math.round,f,g,h=document.createElement("div"),i=h.appendChild(document.createElement("canvas")),j=i.getContext("2d");return h.style.overflow="hidden",a.url=function(b){return arguments.length?(d=typeof b=="string"&&/{.}/.test(b)?_url(b):b,k(),a):d},a.zoom=function(b){return arguments.length?(e=typeof b=="function"?b:function(){return b},k(),a):e},a.visible=function(d){return arguments.length?(c.on("move."+b,(f=d)?k:null),a):f},a.node=function(){return h},a.visible(!0)}})();